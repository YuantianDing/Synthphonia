
# Artifact for Synthphonia (DryadSynth String Solver)

## System Requirement

| Requirement  | CPUs | Memory | Storage |
| :--:         | :--: | :--:   | :--:    |
| Minimum      | 8    | 8 GB   | 32 GB   |
| Recommended  | 16   | 16 GB  | 32 GB   |
| Reproduction | 32   | 128 GB | 64 GB   |

## Getting the Artifact

We provide a prebuilt Docker image for our artifact, available on [Dockerhub](https://hub.docker.com/r/yuantianding/synthphonia) and our [Release Page](https://github.com/YuantianDing/Synthphonia/releases). This image allows you to run the artifact directly, without manually setting up all solvers.

### Building the Artifact Locally

If you prefer, you can build the docker image on your own machine using `artifact.zip`, which is also available on our [Release Page](https://github.com/YuantianDing/Synthphonia/releases). To do this, simply use the provided `Dockerfile`.

### Building Individual Solvers

You can also manually compile all solvers by following the instructions below. For detailed commands and dependencies, check the `Dockerfile`.

- **CVC4** Download and install [CVC4-1.8](https://github.com/CVC4/CVC4-archived/releases/tag/1.8),
- **Duet**: Install OPAM and the following packages: `z3.4.8.9`, `containers`, `containers-data`, `batteries`, `ocamlgraph`, and `sexplib`. Ensure compatibility with your OCaml compiler. **Note:** `python2` is required to build `z3.4.8.9`.
- **Probe**: Install JVM, and make sure `sbt`, and `cvc4` in your `$PATH`, then build using: `sbt assembly`.
- **FlashFill++**: Install [.NET 6.0 SDK](https://dotnet.microsoft.com/en-us/download/dotnet/6.0) and run: `dotnet build`.
- **Synthphonia**: Follow the setup guide in the [Synthphonia repository](https://github.com/YuantianDing/Synthphonia). Note to run `test.py` you will also need to symlink the generated binary `synthphonia` under `solvers/synthphonia` directory:

    ```sh
    cd solvers/synthphonia && ln -s target/release/synthphonia synthphonia
    ```

Additionally, to run the `test.py` script, you need to install the required Python dependencies:
```sh
pip install -r text_utils/requirements.txt
```


## Files of the Artifact

The artifact consists of the following files and directories:

```py
artifact/
    benchmarks/       # 3 categories of benchmarks mentioned used in the paper
        duet/         # For each categories of benchmarks, we provide files of different format.
            sygusif/  # Duet benchmark in `sygusif` format
            sygusif2/ # Duet benchmark in `sygusif2 format
            table/    # Duet benchmark in `sygusif2` format
            test/     # Testing examples of Duet benchmark (`sygusif`)
            ......
        prose/
            ......
        hardbench/
            ......
    result_ref/       # Referential result in the paper. (See `result/` for more details)
    solvers/          # Source code or binaries (in the trimmed docker image) of the solvers
        duet/
        probe/
        prose/
        synthphonia/
    test_utils/       # A Python module required by `test.py`
    test.py           # Testing configuraion, also the script to run tests.
    Dockerfile        # Used to build docker image

    # To be generated
    result/           # Experimental results to be generated by `test.py run all`
        duet/         # Results for the Duet benchmarks
            cvc4/     # Results produced by the CVC4 solver
                ...   # JSON files containing benchmark execution results
            ...
        hardbench/    # Results for the Hardbench
        prose/        # Results for the Prose
    figures/          # Figures to be generated by `test.py draw`
```

## Run the tests

### Basic Usage

`test.py` is a configuration and a script to run/export/view the primary results from the paper. To run all the test, simply run `./test.py run all`, the result will be generated under `result/` directory. This command can be interrupted at any time. It will continue working on the test based on files in `result/` directory. The full test need **one and a half days** to finish, for faster test, you may replace `result/` with `result_ref/` and delete only the benchmarks you want to rerun (e.g. only run flashfill++ and synthphonia two solvers). Refer to [Further configure test cases](#further-configure-test-cases) section for more customization.

`test.py status` will provide the current status of `result` directory. You may use this command to check the current running progress of `./test.py run`.

`test.py draw` will generate figures under `figures` directory, after all results are generated. It will give error if **not all results are generated**.

### Command-line interface

```py
Usage: test.py [OPTIONS] COMMAND [ARGS]...

  CLI for running and exporting benchmark results. Available solvers for each
  benchmark:

  duet: cvc4, probe, flashfill, duet, synthphonia, acs1, acs2, acs4, acs8

  hardbench: cvc4, flashfill, probe, duet, synthphonia, acs1, acs2, acs4, acs8

  prose: cvc4, flashfill, duet, probe, synthphonia, acs1, acs2, acs4, acs8

Options:
  --help  Show this message and exit.

Commands:
  csv     Export results of a benchmark suite (duet, hardbench, prose) to csv.
  draw    Draw figures in `figures` directory.
  run     Run all benchmarks in a benchmark suite (all, duet, hardbench, prose).
  status  Print current running status.
  xlsx    Export results to xlsx.
```

### Further configure test cases

To run all benchmarks on one benchmark categories, simply run `./test.py run [duet/hardbench/prose]`.

For more detailed configurations, you can edit the `test.py` file directly to configure the commands and benchmarks. The structure of `test.py` is shown as follows:

```py
SUITES = {
    "duet": BenchmarkSuite(
        "result/duet",
        benchmark_set= get_benchmark_names("benchmark/duet/table"),
        run_configs= [
            CVCConfig("CVC4", "benchmark/duet/sygusif", ["cvc4", "--lang=sygus1"], test_benchmark_dir="benchmark/duet/test"),
            ProbeConfig("Probe", "benchmark/duet/sygusif", ["solvers/probe/exec.sh"], test_benchmark_dir="benchmark/duet/test"),
            FFConfig("FlashFill", "benchmark/duet/table", ["solvers/prose/exec"], test_benchmark_dir="benchmark/duet/test", display_name="FlashFill++"),
            DuetConfig("Duet", "benchmark/duet/sygusif", ["solvers/duet/exec.sh"], test_benchmark_dir="benchmark/duet/test"),
            RunConfig("Synthphonia", "benchmark/duet/sygusif", ["solvers/synthphonia/synthphonia", "--cfg", "solvers/synthphonia/test/test2map.sl"], test_benchmark_dir="benchmark/duet/test"),
            ......
        ]
    ),
    ......
}

def draw():
    """Draw figures in `figures` directory."""
    ......

if __name__ == '__main__':
    cli = testing_cli(SUITES)
    cli.command(draw)
    cli()
```

Basically, `test.py` has a global variable `SUITES`, which includes all `BenchmarkSuite`. Each `BenchmarkSuite` has a field `run_configs` which lists all available configurations.

Each `RunConfig` has 4 fields, shown as follows: 

```py
class RunConfig:
    name: str                              # The name of the benchmark, `test_utils` will convert this filed to `snake_case` as identifier.
    benchmark_dir: str                     # The directory of the benchmark to run.
    cmd: List[str]                         # The command to run
    test_benchmark_dir: str | None = None  # Directory of testing benchmarks.
```

However, since different solvers have different output, we provide `CVCConfig`, `ProbeConfig`, `FFConfig` and `DuetConfig` as subclasses of `RunConfig`, which has its own way of extracting outputs and verifying the results.

Note that we hardcoded timeout in `test_utils`. To change the timeout of running the solvers, please update the `TIMEOUT` variable in `test_utils/run.py`.

### JSON Result File

Note that one can view the generated JSON file directly by running `cat result/[bench]/[solver]/[result]`. The result file has the following structure:

```js
{
    "status": "S" // for success, or "TO" for timeout and "E" for error.
    "stdout": ...,
    "stderr": ...,
    "returncode": ...,
    "time": ...,
    "cmd": ...,
}
```

## Experiment More

See [YuantianDing/Synthphonia](https://github.com/YuantianDing/Synthphonia) for the command-line usage of Synthphonia.
