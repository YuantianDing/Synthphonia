
# Artifact for Synthphonia (DryadSynth String Solver)

## System Requirement

| Requirement  | CPUs | Memory | Storage |
| :--:         | :--: | :--:   | :--:    |
| Minimum      | 8    | 8 GB   | 32 GB   |
| Recommended  | 16   | 16 GB  | 32 GB   |
| Reproduction | 32   | 128 GB | 64 GB   |

## Getting the Artifact

We provide a prebuilt Docker image for our artifact, available on our [Release Page](https://github.com/YuantianDing/Synthphonia/releases). This image allows you to run the artifact directly, without manually setting up all solvers.

### Building the Artifact Locally

If you prefer, you can build the docker image on your own machine using `artifact.zip`, which is also available on our [Release Page](https://github.com/YuantianDing/Synthphonia/releases). To do this, simply use the provided `Dockerfile`.

You can also manually compile all solvers by following the instructions below. For a more detailed guide, check the `Dockerfile`.

### Building Individual Solvers

- **Duet**: Install OPAM and the following packages: `z3.4.8.9`, `containers`, `containers-data`, `batteries`, `ocamlgraph`, and `sexplib`. Ensure compatibility with your OCaml compiler. **Note:** `python2` is required to build `z3.4.8.9`.
- **Probe**: Install JVM, `sbt`, and `cvc4`, then build using: `sbt assembly`.
- **FlashFill++**: Install [.NET 6.0 SDK](https://dotnet.microsoft.com/en-us/download/dotnet/6.0) and run: `dotnet build`.
- **Synthphonia**: Follow the setup guide in the [Synthphonia repository](https://github.com/YuantianDing/Synthphonia).

To run the `test.py` script, you also need to install the required Python dependencies:
```sh
pip install -r text_utils/requirements.txt
```


## Files of the Artifact

The artifact consists of the following files and directories:

```py
artifact/
    benchmarks/       # 3 categories of benchmarks mentioned used in the paper
        duet/         # For each categories of benchmarks, we provide files of different format.
            sygusif/  # Duet benchmark in `sygusif` format
            sygusif2/ # Duet benchmark in `sygusif2 format
            table/    # Duet benchmark in `sygusif2` format
            test/     # Testing examples of Duet benchmark (`sygusif`)
            ......
        prose/
            ......
        hardbench/
            ......
    result_ref/       # Referential result in the paper. (See `result/` for more details)
    solvers/          # Source code or binaries (in the trimmed docker image) of the solvers
        duet/
        probe/
        prose/
        synthphonia/
    test_utils/       # A Python module required by `test.py`
    test.py           # The main script to run experiments
    Dockerfile        # Used to build docker image

    # To be generated
    result/           # Experimental results to be generated by `test.py run all`
        duet/         # Results for the Duet benchmarks
            cvc4/     # Results produced by the CVC4 solver
                ...   # JSON files containing benchmark execution results
            ...
        hardbench/    # Results for the Hardbench
        prose/        # Results for the Prose
    figures/          # Figures to be generated by `test.py draw`
```

## Run the tests

`test.py` provides a command to run/export/view the primary results from the paper. To run all the test, simply run `./test.py run all`, the result will be generated under `result` directory.

`test.py draw` will generate figures under `figures` directory, after all results are generated. 

Here we list some other functionality of `test.py`:

```md
Usage: test.py [OPTIONS] COMMAND [ARGS]...

Options:
  --help  Show this message and exit.

Commands:
  csv   Export results of a benchmark suite (duet, hardbench, prose) to csv
  draw  Draw figures in `figures` directory (Need all results collected)
  run   Run all benchmarks in a benchmark suite (all, duet, hardbench, prose)
  xlsx  Export results to xlsx
```

To run all benchmarks on one benchmark categorys, simply run `./test.py run [duet/hardbench/prose]`.

For more detailed configurations, you can edit the `test.py` file directly to setup the command to run, the testing benchmark to use, the configuration inside `test.py` is shown as follows:

```py
SUITES = {
    "duet": BenchmarkSuite(
        "result/duet",
        benchmark_set= get_benchmark_names("benchmark/duet/table"),
        run_configs= [
            CVCConfig("CVC4", "benchmark/duet/sygusif", ["cvc4", "--lang=sygus1"], test_benchmark_dir="benchmark/duet/test"),
            ProbeConfig("Probe", "benchmark/duet/sygusif", ["solvers/probe/exec.sh"], test_benchmark_dir="benchmark/duet/test"),
            FFConfig("FlashFill", "benchmark/duet/table", ["solvers/prose/exec"], test_benchmark_dir="benchmark/duet/test", display_name="FlashFill++"),
            DuetConfig("Duet", "benchmark/duet/sygusif", ["solvers/duet/exec.sh"], test_benchmark_dir="benchmark/duet/test"),
            RunConfig("Synthphonia", "benchmark/duet/sygusif", ["solvers/synthphonia/synthphonia", "--cfg", "solvers/synthphonia/test/test2map.sl"], test_benchmark_dir="benchmark/duet/test"),
            ......
        ]
    ),
    ......
}
```

Basically, each `RunConfig` has 4 fields: 

```py
class RunConfig:
    name: str                              # The name of the benchmark, `test_utils` will convert this filed to `snake_case` as identifier.
    benchmark_dir: str                     # The directory of the benchmark to run.
    cmd: List[str]                         # The command to run
    test_benchmark_dir: str | None = None  # Directory of testing benchmarks.
```

However, since different solvers have different output, we provide `CVCConfig`, `ProbeConfig`, `FFConfig` and `DuetConfig` as subclasses of `RunConfig`, which has its own way of extracting outputs and verifying the results.

To change the timeout of running the solvers, please update the `TIMEOUT` variable in `test_utils/run.py`.

## Experiment More

See [YuantianDing/Synthphonia](https://github.com/YuantianDing/Synthphonia) to play with Synthphonia!
